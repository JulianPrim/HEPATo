###############################################################
#       HEPATo (HepG2 Promoter Analysis Tool)                 #
###############################################################
# Description :
#   Interactive R Shiny app for visualizing regulatory landscapes
#   in HepG2 hepatocellular carcinoma cells. Explore ENCODE cCREs,
#   ChIP-Atlas TFs, histone marks, and ATAC-seq around any HGNC gene.
#
# Author      : Julian Primig (Sorbonne UniversitÃ©)
# Repository  : https://github.com/JulianPrim/HEPATo
# Date        : 2025-08-27
# Requirements: R (>=4.2), Bioconductor packages (EnsDb.Hsapiens.v86, etc.)
# Made with: R 4.5.1 and chatGPT5 have been used for code syntax and development
###############################################################

# ---- Inputs expected in working directory ----
#   ENCFF389ZVZ_cCREs.bigBed
#   HepG2_formatted_50_AllAg.bed   (TFs)
#   HepG2_formatted_50_His.bed     (Histone marks)
#   HepG2_formatted_50_ATAC.bed    (ATAC-seq)
# ------------------------------------------------------------

# options(repos="https://cran.rstudio.com")
# if (!requireNamespace("BiocManager", quietly=TRUE)) install.packages("BiocManager")
# install.packages(c("shiny","bslib","dplyr","plotly","RColorBrewer","readr","tibble","htmlwidgets"))
# BiocManager::install(c("EnsDb.Hsapiens.v86","GenomicRanges","IRanges","rtracklayer","AnnotationFilter"), ask=FALSE)

# ---- Packages ----
library(shiny)
library(bslib)
library(EnsDb.Hsapiens.v86)
library(AnnotationFilter)
library(GenomicRanges)
library(IRanges)
library(rtracklayer)
library(dplyr)
library(plotly)
library(RColorBrewer)
library(readr)
library(tibble)
library(htmlwidgets)  # for onRender (JS click handler)

# ---- Constants ----
ccre_classes <- c("PLS","pELS","dELS","CTCF-only","DNase-H3K4me3")
ccre_cols    <- c(PLS="red", pELS="orange", dELS="yellow", `CTCF-only`="blue", `DNase-H3K4me3`="pink")

# Base URL for SRX links on ChIP-Atlas
SRX_URL_BASE <- "https://chip-atlas.org/view?id="

file_for_mode <- function(mode){
  switch(mode,
         tf   = "HepG2_formatted_50_AllAg.bed",
         his  = "HepG2_formatted_50_His.bed",
         atac = "HepG2_formatted_50_ATAC.bed",
         stop("Unknown mode"))
}
mode_label <- function(mode){ c(tf="TFs", his="Histone marks", atac="ATAC-seq")[mode] }
plot_title_for_mode <- function(mode, gene){
  prefix <- switch(mode, tf="cCREs and TFs", his="cCREs and Histone marks", atac="cCREs and ATAC-seq")
  paste0(prefix, " within the ", gene, " genomic region")
}
safe_palette <- function(n){
  if (n <= 0) {
    character(0)
  } else if (n <= 8) {
    # Dark2 needs >= 3; take 3 and subset to n
    RColorBrewer::brewer.pal(max(n, 3), "Dark2")[seq_len(n)]
  } else {
    colorRampPalette(RColorBrewer::brewer.pal(8, "Dark2"))(n)
  }
}


# ---- Load cCREs ----
ccres <- import("ENCFF389ZVZ_cCREs.bigBed", format = "bigBed")
ccres$creClass        <- sub(",.*", "", ccres$ccre)
seqlevelsStyle(ccres) <- "UCSC"; genome(ccres) <- "hg38"; seqlengths(ccres) <- NA

# ---- THEME ----
PASTEL <- "#94d2bd"
theme <- bs_theme(
  version = 5,
  bootswatch = "minty",
  primary = PASTEL,
  base_font = font_google("Inter"),
  heading_font = font_collection("Helvetica Neue", "Arial", "sans-serif")
)

# ---- UI ----
ui <- page_navbar(
  theme = theme,
  title = tags$span("HEPATo: HepG2 Promoter Analysis Tool"),
  tags$head(tags$title("HEPATo: HepG2 Promoter Analysis Tool")),
  # CSS
  tags$head(
    tags$style(HTML(paste0(
      ".app-title{font-family:'Helvetica Neue',Arial,sans-serif;font-weight:800;font-size:2.2rem;line-height:1.15;margin:0 0 .25rem 0;} ",
      ".app-subtitle-lead{color:#111;font-size:1.05rem;line-height:1.2;font-style:italic;margin:.25rem 0 .5rem 0;} ",
      ".app-subtitle-more{color:#111;font-size:.95rem;line-height:1.25;font-style:italic;margin:0 0 1rem 0;} ",
      ".ccre-legend{display:flex;flex-wrap:wrap;align-items:center;gap:12px;margin:.25rem 0 .5rem 0;} ",
      ".ccre-legend-title{font-weight:600;margin-right:.25rem;} ",
      ".ccre-item{display:inline-flex;align-items:center;gap:6px;} ",
      ".ccre-swatch{width:12px;height:12px;border-radius:2px;border:1px solid rgba(0,0,0,.25);display:inline-block;} ",
      ".ccre-help-toggle{font-size:.9em;color:#0b3d91;text-decoration:underline;cursor:pointer;margin-left:8px;} ",
      ".ccre-help{font-size:.9em;color:#333;margin:.25rem 0 .5rem 0;} ",
      ".plot-wrapper{height:72vh;min-height:520px;} ",
      ".bs-card-full-screen .plot-wrapper{height:calc(100vh - 40px);} ",
      ".bs-card-full-screen .hide-on-fullscreen{display:none !important;} ",
      ".tf-legend{max-height:180px;overflow:auto;padding-top:.5rem;border-top:1px solid rgba(0,0,0,.08);} ",
      ".tf-legend-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:6px 16px;} ",
      ".tf-item{display:flex;align-items:center;gap:8px;font-size:.95rem;} ",
      ".tf-swatch{width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.25);display:inline-block;} ",
      ".tf-legend-title{font-weight:600;margin-bottom:.25rem;} ",
      ".note-box{font-size:.9em;background:#f8f9fb;border-left:4px solid ", PASTEL, ";padding:.5rem .7rem;border-radius:4px;color:#111;} ",
      "@media (max-width: 1200px){ .app-title{font-size:2rem;} .app-subtitle-lead{font-size:1rem;} .app-subtitle-more{font-size:.9rem;} }"
    )))
  ),
  
  nav(
    "Explore",
    layout_sidebar(
      sidebar = sidebar(
        width = 360,
        class = "rounded-3 shadow-sm border-0",
        tags$div(class="mb-3",
                 tags$h2("Inputs", class="h5 fw-bold mb-3"),
                 textInput("gene", "Gene name (HGNC)", "EXOSC10"),
                 numericInput("flank", "Flanking sequences (bp)", 2000, min = 0),
                 radioButtons("mode", "Track:", inline = TRUE,
                              choices = c("Transcription factors"="tf","Histone marks"="his","ATAC-seq"="atac"),
                              selected = "tf"),
                 selectizeInput("filter_factor", "Filter TF/mark (optional)",
                                choices = NULL, multiple = TRUE,
                                options = list(placeholder = "All in region")),
                 numericInput("minscore", "Min score", value = 0, min = 0, step = 1),
                 sliderInput("ptsize", "Point size", min = 4, max = 14, value = 8, step = 1),
                 checkboxInput("showccre", "Show cCREs", value = TRUE),
                 checkboxInput("showlegend", "Show TF/mark legend", value = TRUE),
                 actionButton("go", "Display", class = "btn btn-primary w-100")
        )
      ),
      
      # Header
      card(
        class = "shadow-sm rounded-3 border-0 mb-3",
        card_body(
          tags$div(
            tags$div(class = "app-title", "HEPATo: HepG2 Promoter Analysis Tool"),
            tags$div(class = "app-subtitle-lead",
                     "Interactive viewer for exploring regulatory landscapes in HepG2 cells and generating elegant ChIP-seq figures. ",
                     "Browse ENCODE cCREs alongside ChIP-Atlas transcription-factor binding, histone marks, and ATAC-seq around any HGNC gene. ",
                     "Configure the flanking window, filter by factor/mark, and inspect peak scores."),
            tags$div(class = "app-subtitle-more text-muted",
                     "With plotly (v2.11.1), you can lasso-select points, zoom, and pan. ",
                     "Enter a gene and click \"Display\". ",
                     "Each point corresponds to a ChIP-seq experiment (SRX). Hover for details and open the SRX on ChIP-Atlas.")
          )
        )
      ),
      
      # Plot card
      card(
        full_screen = TRUE,
        class = "shadow-sm rounded-3 border-0 mb-3",
        card_body(
          # ---- ALL THREE NOTES (above plot)
          div(class="hide-on-fullscreen",
              actionLink("toggle_hot", "Note about hotspot promoters", class = "link-primary"),
              uiOutput("hotNote"),
              tags$span("  "),
              actionLink("toggle_macs", "Note about MACS2 score", class = "link-primary"),
              uiOutput("macsNote"),
              tags$span("  "),
              actionLink("toggle_note", "Note about experimental conditions", class = "link-primary"),
              uiOutput("noteBox")
          ),
          
          # ---- The plot
          div(class="plot-wrapper",
              plotlyOutput("plot", height = "100%"),
              div(class="plot-helper text-muted",
                  HTML("Click any point to open its SRX on <b>ChIP-Atlas</b> in a new tab.")
              )
          ),
          
          # ---- Legends under the plot
          div(class="hide-on-fullscreen",
              uiOutput("ccreLegend"),
              uiOutput("tfLegend")
          )
        )
      ),
      
      # Region info
      card(
        class = "shadow-sm rounded-3 border-0",
        card_header(tags$div(class="fw-semibold", "Selected region")),
        card_body(tableOutput("regionInfo"))
      )
    )
  ),
  
  nav_spacer(),
  nav_item(tags$a(class="nav-link", target="_blank",
                  href="https://github.com/JulianPrim/HEPATo", icon("github"), " GitHub"))
)

# ---- SERVER ----
server <- function(input, output, session){
  
  # Region computed when user clicks Display
  regionGR <- eventReactive(input$go, {
    txs <- genes(EnsDb.Hsapiens.v86, filter = GeneNameFilter(input$gene))
    validate(need(length(txs) > 0, "Gene not found"))
    gr <- range(txs) + input$flank
    seqlevelsStyle(gr) <- "UCSC"; genome(gr) <- "hg38"; seqlengths(gr) <- NA
    gr
  })
  
  currentBed <- reactive({ file_for_mode(input$mode) })
  
  peaksRawInRegion <- reactive({
    gr0  <- regionGR(); req(gr0)
    file <- currentBed()
    validate(need(file.exists(file), paste0("Missing file: ", file)))
    
    df <- read_tsv(file,
                   col_names = c("chrom","start","end","SRX","gene","score"),
                   show_col_types = FALSE) %>%
      mutate(start = as.numeric(start),
             end   = as.numeric(end),
             score = suppressWarnings(as.numeric(score)))
    
    gr_df <- GRanges(df$chrom, IRanges(df$start, df$end))
    sel   <- queryHits(findOverlaps(gr_df, gr0))
    df    <- df[sel, ]
    validate(need(nrow(df) > 0, "No peaks in region"))
    
    df %>% mutate(
      pos     = (start + end) / 2,
      url     = paste0(SRX_URL_BASE, SRX),
      tooltip = paste0(
        "Type: ", mode_label(input$mode),
        "<br>Mark/TF: ", gene,
        "<br>SRX: <a href='", SRX_URL_BASE, SRX, "' target='_blank'>", SRX, "</a>",
        "<br>", chrom, ":", start, "-", end,
        "<br>Score (MACS2, 0â1000): ", score
      )
    )
  })
  
  # Fill filter on first Display
  available_factors <- reactive({
    df <- peaksRawInRegion()
    sort(unique(df$gene))
  })
  observeEvent(available_factors(), {
    updateSelectizeInput(session, "filter_factor",
                         choices = available_factors(), selected = character(0), server = TRUE)
  })
  
  peaksInRegion <- reactive({
    df <- peaksRawInRegion()
    if (!is.null(input$filter_factor) && length(input$filter_factor) > 0) {
      df <- dplyr::filter(df, gene %in% input$filter_factor)
    }
    dplyr::filter(df, score >= input$minscore)
  })
  
  # Shared color mapping for plot + custom legend
  legend_colors <- reactive({
    df <- peaksInRegion()
    genes_present <- sort(unique(df$gene))
    pal <- safe_palette(length(genes_present))
    setNames(pal, genes_present)
  })
  
  output$plot <- renderPlotly({
    gr <- regionGR(); req(gr)
    df <- peaksInRegion(); validate(need(nrow(df) > 0, "No data after filtering"))
    
    tf_colors <- legend_colors()
    
    # cCRE rectangles (background)
    shapes <- NULL
    if (isTRUE(input$showccre)) {
      cc0 <- subsetByOverlaps(ccres, gr)
      if (length(cc0) > 0) {
        ccdf <- as_tibble(cc0) %>% transmute(
          x0 = start, x1 = end,
          cls = factor(creClass, levels = ccre_classes)
        )
        shapes <- lapply(seq_len(nrow(ccdf)), function(i){
          list(type = "rect", xref = "x", yref = "paper",
               x0 = ccdf$x0[i], x1 = ccdf$x1[i], y0 = 0, y1 = 1,
               fillcolor = ccre_cols[as.character(ccdf$cls[i])],
               opacity = 0.3, line = list(width = 0), layer = "below")
        })
      }
    }
    
    p <- plot_ly(
      df,
      x = ~pos, y = ~score,
      text = ~tooltip, hoverinfo = "text",
      type = "scatter", mode = "markers",
      marker = list(size = input$ptsize, opacity = 1),
      color = if (input$mode == "atac") I("black") else ~gene,
      colors = if (input$mode == "atac") NULL else tf_colors,
      showlegend = FALSE,
      customdata = ~url   # pass target URL to JS
    ) %>%
      layout(
        title  = list(text = paste0("<b>", plot_title_for_mode(input$mode, input$gene), "</b>")),
        shapes = shapes,
        margin = list(l = 96, r = 28, t = 64, b = 72),
        xaxis  = list(title = paste0(as.character(seqnames(gr)), ":", start(gr), "-", end(gr)),
                      automargin = TRUE),
        yaxis  = list(title = list(text = "<b>MACS2 binding score</b>"),
                      automargin = TRUE)
      ) %>%
      config(displaylogo = FALSE, responsive = TRUE)
    
    # Open SRX page when a point is clicked
    p <- htmlwidgets::onRender(p, "
      function(el, x) {
        el.on('plotly_click', function(e) {
          if (e && e.points && e.points.length > 0) {
            var url = e.points[0].customdata;
            if (url) window.open(url, '_blank');
          }
        });
      }
    ")
    
    p
  })
  
  # cCRE legend (contextual)
  ccre_help_open <- reactiveVal(FALSE)
  observeEvent(input$ccre_help_toggle, { ccre_help_open(!ccre_help_open()) })
  output$ccreLegend <- renderUI({
    if (!isTRUE(input$showccre)) return(NULL)
    gr <- regionGR(); req(gr)
    
    cc0 <- subsetByOverlaps(ccres, gr)
    if (length(cc0) == 0) return(NULL)
    
    present <- unique(as.character(cc0$creClass))
    present <- intersect(ccre_classes, present)
    if (length(present) == 0) return(NULL)
    
    items <- lapply(present, function(cls) {
      tags$span(class = "ccre-item",
                tags$span(class = "ccre-swatch", style = paste0("background:", ccre_cols[[cls]], ";")),
                tags$span(cls))
    })
    
    help_text <- NULL
    if (isTRUE(ccre_help_open())) {
      help_text <- tags$div(class="ccre-help",
                            HTML("Promoter-like signature (PLS) &middot; proximal enhancer-like signature (pELS) &middot; distal enhancer-like signature (dELS)."),
                            tags$br(),
                            HTML("Colors: <span style='color:red;font-weight:600'>PLS</span>, ",
                                 "<span style='color:orange;font-weight:600'>pELS</span>, ",
                                 "<span style='color:goldenrod;font-weight:600'>dELS</span>, ",
                                 "<span style='color:blue;font-weight:600'>CTCF-only</span>, ",
                                 "<span style='color:hotpink;font-weight:600'>DNase-H3K4me3</span>.")
      )
    }
    
    tags$div(
      tags$div(class = "ccre-legend",
               tags$span(class = "ccre-legend-title", "ENCODE cCRE:"),
               items,
               actionLink("ccre_help_toggle", "What do colors mean?", class = "ccre-help-toggle")
      ),
      help_text
    )
  })
  
  # Custom TF/mark legend
  output$tfLegend <- renderUI({
    if (!isTRUE(input$showlegend) || input$mode == "atac") return(NULL)
    cols <- legend_colors()
    if (length(cols) == 0) return(NULL)
    
    items <- lapply(names(cols), function(name) {
      tags$div(class="tf-item",
               tags$span(class="tf-swatch", style = paste0("background:", cols[[name]], ";")),
               tags$span(name))
    })
    tags$div(class="tf-legend",
             tags$div(class="tf-legend-title", "TF/mark legend:"),
             tags$div(class="tf-legend-grid", items))
  })
  
  # HOT promoter note
  hot_open <- reactiveVal(FALSE)
  observeEvent(input$toggle_hot, { hot_open(!hot_open()) })
  output$hotNote <- renderUI({
    if (!hot_open()) return(NULL)
    tags$div(class="note-box", HTML("
<ul style='margin:6px 0 0 18px'>
  <li><b>Highly open, strongly transcribed promoters</b> (CpG islands, Pol II, H3K4me3/H3K27ac) can yield non-specific enrichments (âphantom peaksâ).</li>
  <li><b>Physicochemical features of HOT regions</b> (high GC/CpG, R-loops, G-quadruplexes) may inflate scores.</li>
  <li><b>Large ZNF family</b> and shared cofactors lead to frequent co-IP at transcriptional hubs.</li>
  <li><b>Multi-study aggregation</b> can amplify apparent ubiquity at HOT promoters.</li>
  <li><b>3D proximity/looping</b> may project signal near active TSSs. See PMIDs: 31114922, 24173036, 26117547.</li>
</ul>
<div style='margin-top:6px;font-size:0.9em;color:#555'>
  Advice: check motif enrichment and peak centering for biologically relevant targets.
</div>
"))
  })
  
  # MACS2 / narrowPeak score comparability note
  macs_open <- reactiveVal(FALSE)
  observeEvent(input$toggle_macs, { macs_open(!macs_open()) })
  output$macsNote <- renderUI({
    if (!macs_open()) return(NULL)
    tags$div(class = "note-box", HTML("
<ul style='margin:6px 0 0 18px'>
  <li><b>Displayed score = MACS2 (â10Â·log10 q-value) in <code>narrowPeak</code> format (0â1000)</b>, optimized for <em>visualization/ranking</em>.</li>
  <li><b>Not a raw statistic</b> and <b>not comparable across studies</b> (different SRXs).</li>
  <li>Scale varies with antibody, sequencing depth, controls, MACS2 parameters, and processing pipelines.</li>
  <li><b>Reasonable comparison:</b> <u>within the same SRX</u> to rank peaks. Do not infer that TF A âbinds moreâ than TF B across SRXs.</li>
</ul>
<div style='margin-top:6px;font-size:0.9em;color:#555'>
  Tip: use this score as a <em>presence/priority cue</em>, not as a cross-SRX intensity measure.
</div>
"))
  })
  
  # Experimental conditions note
  show_note <- reactiveVal(FALSE)
  observeEvent(input$toggle_note, { show_note(!show_note()) })
  output$noteBox <- renderUI({
    if (!show_note()) return(NULL)
    tags$div(class = "note-box",
             HTML("Some experiments include <em>treatments</em> (e.g., stimuli, drugs, knockdowns).
           These conditions are <strong>not annotated</strong> in the viewer. For accurate interpretation,
           copy the SRX ID of points of interest and review full metadata on <strong>ChIP-Atlas</strong>.")
    )
  })
  
  # Region info table
  output$regionInfo <- renderTable({
    gr <- regionGR(); req(gr)
    data.frame(
      Chromosome = as.character(seqnames(gr)),
      Start      = start(gr),
      End        = end(gr),
      Width      = width(gr),
      Track      = mode_label(input$mode)
    )
  })
}

shinyApp(ui, server)
